## 22. 右键菜单

> 通过右键选择 关闭所有、 关闭其他、 关闭当前、刷新 对于 tag affix 为 true 的固定 tag 是不允许关闭删除的

### 22.1 修改 tagsView 组件

添加下拉菜单

> 需要使用 element dropdown 组件，给每一个 tag 添加。

src/layout/components/TagsView/index.vue

```vue
<template>
  <div class="tags-view-container">
    <scroll-panel>
      <div class="tags-view-wrapper">
        <!-- 一个个tag view就是router-link -->
        <router-link
          class="tags-view-item"
          :class="{
            active: isActive(tag),
          }"
          v-for="(tag, index) in visitedViews"
          :key="index"
          :to="{ path: tag.path, query: tag.query }"
        >
          <el-dropdown
            trigger="contextmenu"
            @command="(command: any) => handleTagCommand(command, tag)"
          >
            <span style="line-height: 26px">{{ tag.meta.title }}</span>
            <span
              v-if="!isAffix(tag)"
              class="el-icon-close"
              @click.prevent.stop="closeSelectedTag(tag)"
            ></span>
            <template #dropdown>
              <el-dropdown-item command="all">关闭所有</el-dropdown-item>
              <el-dropdown-item command="other">关闭其他</el-dropdown-item>
              <el-dropdown-item command="self">关闭</el-dropdown-item>
              <el-dropdown-item command="refresh">刷新</el-dropdown-item>
            </template>
          </el-dropdown>
          <el-icon class="icon-close" v-if="!isAffix(tag)">
            <CloseBold @click.prevent.stop="closeSelectedTag(tag)" />
          </el-icon>
        </router-link>
      </div>
    </scroll-panel>
  </div>
</template>
```

### 22.2 添加右键事件

```ts
const enum TagCommandType {
  All = "all",
  Other = "other",
  Self = "self",
  Refresh = "refresh",
}
const handleTagCommand = (
  command: TagCommandType,
  view: RouteLocationNormalized
) => {
  switch (command) {
    case TagCommandType.All: // 右键删除标签导航所有tag 除了affix为true的
      // handleCloseAllTag(view)
      break;
    case TagCommandType.Other: // 关闭其他tag 除了affix为true的和当前右键的
      tag;
      // handleCloseOtherTag(view)
      break;
    case TagCommandType.Self: // 关闭当前右键的tag affix为true的tag下拉菜单中
      无此项;
      // closeSelectedTag(view)
      break;
    case TagCommandType.Refresh: // 刷新当前右键选中tag对应的路由
      // refreshSelectedTag(view)
      break;
  }
};
```

### 22.3 修改 store

> 我们的 tag 列表和缓存列表都在 store 所有对于它们的增删改查需要 调用 action 来删除

src/stores/tagsView.ts

```ts
const delAllView = () => {
  visitedViews.value = visitedViews.value.filter((tag) => tag.meta.affix);
  cachedViews.value = [];
};

const delOthersViews = (view: RouteLocationNormalized) => {
  visitedViews.value = visitedViews.value.filter(
    (tag) => tag.meta.affix || tag.path === view.path
  );
  cachedViews.value = cachedViews.value.filter((name) => name !== view.name);
};

/* 记得return */
```

### 22.4 右键关闭其他和关闭和右键刷新

src/layout/components/TagsView/index.vue

```vue
<template>
  ...
  <el-dropdown-menu>
    <el-dropdown-item command="all">关闭所有</el-dropdown-item>
    <el-dropdown-item command="other">关闭其他</el-dropdown-item>
    +
    <el-dropdown-item command="self" v-if="!tag.meta || !tag.meta.affix"
      >关闭</el-dropdown-item
    >
    <el-dropdown-item command="refresh">刷新</el-dropdown-item>
  </el-dropdown-menu>
  ...
</template>

<script lang="ts" setup>
const handleTagCommand = (
  command: TagCommandType,
  view: RouteLocationNormalized
) => {
  switch (command) {
    case TagCommandType.All: // 右键删除标签导航所有tag 除了affix为true的
      handleCloseAllTag(view);
      break;
    case TagCommandType.Other: // 关闭其他tag 除了affix为true的和当前右键的
      tag;
      handleCloseOtherTag(view);
      break;
    case TagCommandType.Self: // 关闭当前右键的tag affix为true的tag下拉菜单中
      无此项;
      closeSelectedTag(view);
      break;
    case TagCommandType.Refresh: // 刷新当前右键选中tag对应的路由
      refreshSelectedTag(view);
      break;
  }
};

const handleCloseAllTag = (view: RouteLocationNormalized) => {
  // 对于是affix的tag是不会被删除的
  store.delAllView();
  // 关闭所有后 就让切换到剩下affix中最后一个tag
  toLastView(visitedViews.value, view);
};
const handleCloseOtherTag = (view: RouteLocationNormalized) => {
  store.delOthersViews(view);
  if (!isActive(view)) {
    // 删除其他tag后 让该view路由激活
    router.push(view.path);
  }
};

const refreshSelectedTag = async (view: RouteLocationNormalized) => {
  // 刷新前 将该路由名称从缓存列表中移除
  store.delCachedView(view);
  // router.push(view.path) // 无法刷新页面，因为页面没有任何变化
  router.push("/redirect" + view.path); // 跳转重定向路由
};
</script>
```

### 22.5 重定向路由

src/router/index.ts

```ts
const constantRoutes: Array<RouteRecordRaw> = [
  ...,
  {
    path: "/redirect",
    component: Layout,
    meta: {
      hidden: true,
    },
    children: [
      {
        // 带参数的动态路由正则匹配 文档说明
        // https://next.router.vuejs.org/zh/guide/essentials/routematchingsyntax.html#%E5%8F%AF%E9%87%8D%E5%A4%8D%E7%9A%84%E5%8F%82%E6%95%B0
        path: "/redirect/:path(.*)", // 要匹配多级路由 应该加*号
        component: () => import("@/views/redirect/index.vue"),
      },
    ],
  },
];
```

增添 src/views/redirect/index.vue 页面

```vue
<script lang="ts">
export default {
  name: "Redirect",
  setup() {
    const route = useRoute();
    const router = useRouter();
    const { query, params } = route;
    router.replace({
      path: "/" + params.path,
      query,
    });
    return () => {
      return h("template");
    };
  },
};
</script>
```

### 22.6 404 路由添加

```ts
const constantRoutes: Array<RouteRecordRaw> = [
  ...,
  {
    path: "/:pathMatch(.*)*",
    redirect: "/404",
    meta: {
      hidden: true,
    },
  },
  {
    path: "/404",
    component: () => import("@/views/error-page/404.vue"),
    meta: {
      hidden: true, // 404 hidden掉
    },
  },
];
```

src/views/error-page/404.vue

```vue
<template>404</template>
```
