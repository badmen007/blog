## 23.动态修改主题

### 23.1 Navbar 添加设置图标

src/layout/components/Navbar.vue

```vue
<template>
  <div class="navbar">
    <hambuger @toggleClick="toggleSidebar" :is-active="sidebar.opened" />
    <breadcrumb></breadcrumb>
    <div class="right-menu">
      <!-- 设置 -->
      <div
        @click="openShowSetting"
        class="setting right-menu-item hover-effect"
      >
        <el-icon><Setting /></el-icon>
      </div>
      <!-- ... -->
    </div>
  </div>
</template>
<script lang="ts" setup>
// ...
import { Setting } from "@element-plus/icons-vue";
const emit = defineEmits<{
  (event: "showSetting", isShow: boolean): void;
}>();
// 打开设置面板,触发对应的事件
const openShowSetting = () => {
  emit("showSetting", true);
};
</script>
<style lang="scss" scoped>
.navbar {
  display: flex;
  background: #fff;
  border-bottom: 1px solid rgba(0, 21, 41, 0.08);
  box-shadow: 0 1px 4px rgba(0, 21, 41, 0.08);
  .right-menu {
    // ...
    .setting {
      font-size: 26px;
      display: flex;
      align-items: center;
    }
  }
}
</style>
```

### 23.2 封装 RightPanel 组件

点击设置右边出来设置面板

src/components/RightPanel/index.vue

```vue
import { emit } from 'process';
<template>
  <div class="right-panel">
    <el-drawer
      :model-value="modelValue"
      :direction="direction"
      :show-close="showClose"
      :custom-class="customClass"
      :with-header="withHeader"
      :title="title"
      :size="size"
      @close="handleClose"
    >
      <slot />
    </el-drawer>
  </div>
</template>

<script lang="ts" setup>
defineProps({
  modelValue: {
    type: Boolean,
    default: true,
  },
  direction: {
    type: String,
    validator(val: string) {
      return ["rtl", "ltr", "ttb", "btt"].includes(val);
    },
    default: "rtl",
  },
  title: {
    type: String,
    default: "自定义title",
  },
  size: {
    type: [String, Number],
  },
  customClass: {
    type: String,
    default: "setting-panel",
  },
  showClose: {
    type: Boolean,
    default: true,
  },
  withHeader: {
    type: Boolean,
    default: true,
  },
});

const emit = defineEmits(["update:modelValue", "close"]);
const handleClose = () => {
  emit("update:modelValue", false);
  emit("close");
};
</script>
```

src/layout/index.vue

```vue
<template>
  <div class="app-wrapper">
    <div class="sidebar-container">
      <Sidebar></Sidebar>
    </div>
    <div class="main-container">
      <div class="header">
        <navbar @showSetting="openSetting"></navbar>
        <tags-view></tags-view>
      </div>
      <app-main></app-main>
    </div>
    <!-- 增添right-panel -->
    <right-panel
      v-model="showSetting"
      title="样式风格设置"
      :size="settingsPanelWidth"
    >
      <!-- settings 面板设置组件,稍后实现 -->
      <settings />
    </right-panel>
  </div>
</template>
<script lang="ts" setup>
import variables from "@/styles/variables.module.scss";

const showSetting = ref(false);

const openSetting = () => {
  // 控制right-panel弹出
  showSetting.value = true;
};
const settingsPanelWidth = computed(() => variables.settingPanelWidth);
</script>
```

**调整样式修改 scss 变量**

src/styles/variables.module.scss

```scss
$settingPanelWidth: 260px;
$theme: #409eff;
:export {
  ....
  theme: $theme;
  settingPanelWidth: $settingPanelWidth;
}
```

variables.module.scss.d

```ts
export interface ScssVariables {
  ...
  theme: string
  settingPanelWidth: string
}

```

### 23.3 store 中存储 theme

src/stores/settings.ts

```ts
import variables from "@/styles/variables.module.scss";
import { defineStore } from "pinia";

export const useSettingsStore = defineStore(
  "settings",
  () => {
    // theme是用户选择的主题
    // originalTheme是现在生效的主题, 刷新需要重新生成无需存放到sessionStorage中
    const settings = reactive({ theme: variables.theme, originalTheme: "" });
    type ISettings = typeof settings;
    type ValueOf<T> = T[keyof T];

    // 修改设置
    const changeSetting = ({
      key,
      value,
    }: {
      key: keyof ISettings;
      value: ValueOf<ISettings>;
    }) => {
      settings[key] = value;
    };

    return { settings, changeSetting };
  },
  {
    persist: {
      storage: window.sessionStorage,
      paths: ["settings.theme"],
    },
  }
);
```

### 23.4 创建 ThemePicker 组件

src/components/ThemePicker/index.vue

```vue
<template>
  <el-color-picker
    v-model="theme"
    class="theme-picker"
    :predefine="themeColor"
    popper-class="theme-picker-dropdown"
  />
</template>
<script lang="ts" setup>
// 预设可选颜色
import { useSettingsStore } from "@/stores/settings";
const store = useSettingsStore();
const themeColor = [
  "#409EFF",
  "#1890ff",
  "#304156",
  "#212121",
  "#11a983",
  "#13c2c2",
  "#6959CD",
  "#f5222d",
];
// store中获取默认主题色
const defaultTheme = computed(() => store.settings.theme);
const theme = ref("");

// 监听默认样式
watch(
  defaultTheme,
  (value) => {
    theme.value = value;
  },
  {
    immediate: true,
  }
);
// 根据theme选择变化 重新生成主题
watch(theme, (value) => {
  // 同步store
  store.changeSetting({ key: "theme", value });
  // 稍后这里生成主题
  // 同步store
  // generateTheme(value)
});
</script>
<style lang="scss">
.theme-picker {
  height: 26px !important;
  margin-right: 8px;
  .el-color-picker__trigger {
    height: 26px !important;
    width: 26px !important;
    padding: 2px;
  }
}
.theme-message,
.theme-picker-dropdown {
  z-index: 99999 !important;
}
.theme-picker-dropdown .el-color-dropdown__link-btn {
  display: none;
}
</style>
```

### 23.5 创建 Settings 组件

src/layout/components/Settings/index.vue

```vue
<template>
  <div class="drawer-container">
    <div class="drawer-item">
      <span>主题色</span>
      <theme-picker />
    </div>
  </div>
</template>
<style lang="scss" scoped>
.drawer-container {
  padding: 24px;
  font-size: 14px;
  line-height: 1.5;
  word-wrap: break-word;
  .drawer-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    font-size: 16px;
    color: rgba(0, 0, 0, 0.65);
  }
}
</style>
```

### 23.6 安装 css-color-function

> 将通过该包提供的 convert 函数生成将 css color-mod 函数生成的渐变色 转换成 rgb

```
// 下面color函数以及 shade tin是css的color-mod函数
// 了解文档 http://cdn1.w3cplus.com/css4/color-mod.html
'color(#11A983 shade(10%))' => 'rgb(15, 152, 118)'
'color(#11A983 tint(10%))' => 'rgb(41, 178, 143)'
'color(#11A983 tint(20%))' => 'rgb(65, 186, 156)'
'color(#11A983 tint(30%))' => 'rgb(88, 195, 168)'
'color(#11A983 tint(40%))' => 'rgb(112, 203, 181)'
'color(#11A983 tint(50%))' => 'rgb(136, 212, 193)'
'color(#11A983 tint(60%))' => 'rgb(160, 221, 205)'
'color(#11A983 tint(70%))' => 'rgb(184, 229, 218)'
'color(#11A983 tint(80%))' => 'rgb(207, 238, 230)'
'color(#11A983 tint(90%))' => 'rgb(231, 246, 243)'
// 利用css-color-function转换为rgb
import color from 'css-color-function'
color.convert('color(#11A983 shade(10%))') // 'rgb(15, 152, 118)'
```

> pnpm i css-color-function

需要注意该包没有声明文件 需要自己定义下

/src/vite-env.d.ts

```ts
declare module "css-color-function" {
  export function convert(color: string): string;
}
```

编写生成样式方法

src/utils/color.ts

```ts
import color from "css-color-function";
const formula: { [prop: string]: string } = {
  "primary-light-1": "color(primary tint(10%))",
  "primary-light-2": "color(primary tint(20%))",
  "primary-light-3": "color(primary tint(30%))",
  "primary-light-4": "color(primary tint(40%))",
  "primary-light-5": "color(primary tint(50%))",
  "primary-light-6": "color(primary tint(60%))",
  "primary-light-7": "color(primary tint(70%))",
  "primary-light-8": "color(primary tint(80%))",
  "primary-light-9": "color(primary tint(90%))",
};
const generateColors = (primary: string) => {
  const colors: Record<string, string> = {};
  Object.keys(formula).forEach((key) => {
    const value = formula[key].replace(/primary/g, primary);
    colors[key] = color.convert(value); // 转换成rgba颜色值
  });
  return colors;
};
const setColors = (colors: Record<string, string>) => {
  const el = document.documentElement;
  Object.entries(colors).map(([key, value]) => {
    el.style.setProperty(`--el-color-${key}`, value);
  });
};
export { generateColors, setColors };
```

### 23.7 主题生成逻辑

> 最开始需要在 App.vue 中调用生成主题 hooks useGenerateTheme
> ThemePicker 组件里也要调用 useGenerateTheme 更好选择的主题颜色 生成主题

src/App.vue

```vue
<template>
  <el-config-provider :size="size" :locale="zhCn">
    <router-view></router-view>
  </el-config-provider>
</template>
<script setup lang="ts">
import zhCn from "element-plus/dist/locale/zh-cn.mjs";
import { storeToRefs } from "pinia";
+import { useGenerateTheme } from "@/hook/useGenerateTheme";
import { useAppStore } from "./stores/app";
const store = useAppStore();
const { size } = storeToRefs(store);
+ useGenerateTheme();
</script>
```

创建 useGenerateTheme Hook 函数

src/hooks/useGenerateTheme.ts

```ts
import { useSettingsStore } from "@/stores/settings";
import { generateColors, setColors } from "@/utils/color";
export const useGenerateTheme = () => {
  // 获得settingsStore
  const store = useSettingsStore();
  const theme = computed(() => store.settings.theme); // 默认主题
  const originalTheme = computed(() => store.settings.originalTheme);
  const generateTheme = (primary: string) => {
    const colors = Object.assign(
      // 根据当前主题生成
      {
        primary: theme.value,
      },
      generateColors(primary)
    );
    setColors(colors);
  };
  // 用户选择的主题和当前主题不一致，则生成主题
  if (theme.value !== originalTheme.value) {
    generateTheme(theme.value);
    // 同步最新主题
    store.changeSetting({ key: "originalTheme", value: theme.value });
  }
  return {
    generateTheme,
  };
};
```

### 23.8 修改 tagviews 组件使用主题色

src/layout/components/TagsView/index.vue

```vue
<template>
  <router-link
    ...
    :style="{
      backgroundColor: isActive(tag) ? themeColor : '',
      borderColor: isActive(tag) ? themeColor : '',
    }"
  >
    ...
  </router-link>
</template>

<script lang="ts" setup>
// 主题色
import { useSettingsStore } from "@/stores/settings";
const settingStore = useSettingsStore();
const themeColor = computed(() => settingStore.settings.theme);
</script>
```

### 23.9 修改 sidebar 使用主题色

```vue
<template>
  <el-menu ... :active-text-color="themeColor" ...>
    <!-- 循环sidebar-item组件 -->
    ...
  </el-menu>
</template>

<script lang="ts" setup>
// 主题色
import { useSettingsStore } from "@/stores/settings";
const settingStore = useSettingsStore();
const themeColor = computed(() => settingStore.settings.theme);
</script>
```