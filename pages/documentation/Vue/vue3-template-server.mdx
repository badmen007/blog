# Vue-template-server / node 服务搭建

## 1. 初始化项目

### 1.1 创建 vue3-admin-server 文件夹

```bash
cd vue3-admin-server
pnpm init
```

### 1.2 安装依赖

```bash
pnpm i @koa/cors @koa/router koa koa-json koa-bodyparser koa-logger
```

安装 ts 相关包

```bash
pnpm i -D @types/koa @types/koa-bodyparser @types/koa-json @types/koalogger @types/koa__cors @types/koa__router typescript
```

安装 node 工具

```bash
pnpm i ts-node nodemon -D
```

### 1.3 创建入口文件

src/app.ts

```ts
import Koa from "koa";
import cors from "@koa/cors";
import logger from "koa-logger";
import bodyparser from "koa-bodyparser";
// routes
import authRoutes from "./routes/auth";
// koa应用实例
const app = new Koa();
// middlewares
app.use(cors()); // 支持跨域
app.use(
  bodyparser({
    // 解析请求体
    enableTypes: ["json", "form", "text"],
  })
);
app.use(logger()); // 开发日志中间件
// routes
// 用户验证路由（登录 注册）
app.use(authRoutes.routes()).use(authRoutes.allowedMethods());
// listen
const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`server listening on ${port}`);
});
app.on("error", (err) => console.error("server error", err));
```

### 1.4 创建 routes 管理路由

> src/routes 是专门存放 router

src/routes/auth.ts

```ts
import Router from "@koa/router";
const router = new Router({
  prefix: "/auth",
});
router.get("/test", async (ctx) => {
  ctx.body = "auth test router";
});
export default router;
```

### 1.5 配置 npm script

```json
{
  "scripts": {
    "serve": "nodemon -i ./node_modules/ --exec \"ts-node\" src/app.ts"
  }
}
```

### 1.6 运行

```bash
npm run serve
```

## 2.mysql 创建 user 表

### 2.1 安装依赖

```bash
pnpm i mysql2 sequelize sequelize-typescript reflect-metadata
pnpm install --save-dev @types/node @types/validator
```

> npx tsc --init 初始化 ts 配置文件

```json
{
  "compilerOptions": {
    "target": "es2016",
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true,
    "strictNullChecks": false
    // ...
  }
}
```

### 2.2 连接 mysql

> [sequelize](https://sequelize.org/docs/v6/getting-started/#installing)

**创建连接**

src/db/seq.ts

```ts
import { Sequelize } from "sequelize-typescript";
const sequelize = new Sequelize({
  host: "localhost",
  database: "vue3-admin",
  timezone: "+08:00",
  dialect: "mysql",
  username: "root",
  password: "",
  models: [__dirname + "/models/*.model.ts"], // or [User, Role],
  pool: {
    // 连接池
    max: 5, // 最大连接数量
    min: 0,
    idle: 10000, // 一个连接池10s之内 没有被使用 则释放
  },
});
export default sequelize;
```

**定义 model**

> 定义 model 就相当于定义 schema 定义表

src/db/models/User.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
  AllowNull,
  Default,
} from "sequelize-typescript";
// sequelize+typescript 参考文档
// https://sequelize.org/master/manual/typescript.html
export interface UserAttributes {
  id: number;
  username: string;
  password: string;
  email: string | null;
  mobile: string | null;
  avatar: string;
  description: string;
  isSuper: 0 | 1;
  status: 0 | 1;
}
interface UserCreationAttributes
  extends Optional<UserAttributes, "id" | "isSuper" | "status" | "avatar"> {}
@Table({ tableName: "user" })
class User extends Model<UserAttributes, UserCreationAttributes> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("用户id")
  @Column
  id: number;
  @AllowNull(false)
  @Comment("用户名")
  @Column
  username: string;
  @AllowNull(false)
  @Comment("密码")
  @Column
  password: string;
  @Comment("用户邮箱")
  @Column
  email: string;
  @Comment("手机号")
  @Column
  mobile: string;
  @Comment("头像")
  @Column
  avatar: string;
  @Comment("描述说明")
  @Column
  description: string;
  @Comment("超级管理员 1是 0不是")
  @Default(0)
  @Column
  isSuper: boolean;
  @Comment("账户禁用状态 1正常 0禁用")
  @Default(1)
  @Column
  status: boolean;
}
export default User;
```

src/db/models/index.ts

```ts
import UserModel from "./User.model";
export { UserModel };
```

**测试连接**

src/db/index.ts

```ts
import sequelize from "./seq";
(async () => {
  try {
    await sequelize.authenticate();
    console.log("Connection has been established successfully.");
  } catch (error) {
    console.error("Unable to connect to the database:", error);
  }
})();
// 同步更新model
(async () => {
  // model配置修改后 执行sync进行更新同步
  await sequelize.sync({ alter: true });
  console.log("sync ok");
})();
```

**配置 script**

```json
{
  "scripts": {
    "serve": "nodemon -i ./node_modules/ --exec \"ts-node\" src/app.ts",
    "db": "ts-node ./src/db/index.ts"
  }
}
```

运行

```bash
npm run db
```

> 最终将脚本引入到 app.ts 中

```bash
import "./db";
```

## 3.公共封装及完成注册接口

> 目录设计 (routes 存放路由) (controller 存放控制器) (services 管理 model 层)
> router->controller-services->mysql

### 3.1 公共配置

> 错误信息管理: 根据接口错误 返回对应错误信息

src/constants/errorInfo.ts

```ts
export default {
  // 用户名已存在
  registerUserNameExistInfo: {
    code: 10001,
    message: "用户名已存在",
  },
  // 注册失败
  registerFailInfo: {
    code: 10002,
    message: "注册失败，请重试",
  },
  // 用户名不存在
  registerUserNameNotExistInfo: {
    code: 10003,
    message: "用户名未存在",
  },
  // 登录失败
  loginFailInfo: {
    code: 10004,
    message: "登录失败，用户名或密码错误",
  },
  // 未登录
  loginCheckFailInfo: {
    code: 10005,
    message: "您尚未登录",
  },
  // 修改密码失败
  changePasswordFailInfo: {
    code: 10006,
    message: "修改密码失败，请重试",
  },
  // 用户信息失败
  getUserInfoFailInfo: {
    code: 10007,
    message: "用户信息获取失败 token验证无效",
  },
  getUserListFailInfo: {
    code: 10008,
    message: "用户列表获取失败, 请重试",
  },
  editUserInfoFailInfo: {
    code: 10009,
    message: "用户信息修改失败, 请重试",
  },
  deleteUserInfoFailInfo: {
    code: 10010,
    message: "用户删除失败, 请重试",
  },
  updateUserRoleFailInfo: {
    code: 10011,
    message: "用户角色修改失败,请重试",
  },
  addAccessFailInfo: {
    code: 10012,
    message: "菜单添加失败",
  },
  getAccessAllFailInfo: {
    code: 10013,
    message: "获取全部菜单失败",
  },
  removeAccessFailInfo: {
    code: 10014,
    message: "删除菜单失败",
  },
  updateAccessFailInfo: {
    code: 10015,
    message: "编辑菜单失败",
  },
  addRoleFailInfo: {
    code: 10016,
    message: "添加角色失败",
  },
  addRoleNameExistInfo: {
    code: 10017,
    message: "角色已存在, 不能重复添加",
  },
  updateRoleFailInfo: {
    code: 10018,
    message: "编辑角色失败",
  },
  updateRoleNameExistInfo: {
    code: 10019,
    message: "编辑失败，已存在同名角色",
  },
  removeRoleFailInfo: {
    code: 10020,
    message: "角色删除失败",
  },
  allocRoleAccessFailInfo: {
    code: 10021,
    message: "角色分配权限失败",
  },
  getRoleAccessFailInfo: {
    code: 10022,
    message: "根据角色获取权限失败",
  },
  updateUserExistFailInfo: {
    code: 10023,
    message: "用户信息修改失败，已存在同名用户",
  },
  allocUserRoleFailInfo: {
    code: 10024,
    message: "用户角色分配失败",
  },
  uploadUserAvatarFailInfo: {
    code: 10025,
    message: "头像上传失败",
  },
  accountForbiddenFailInfo: {
    code: 10026,
    message: "登录失败，账号已被禁用！",
  },
};
```

### 3.2 存放密钥

src/config/auth.ts

```bash
// jwt加密用
export const jwtSecret = "vue3-admin-jwt";
// MD5加密用（比如用户密码 需要加密后再存放到数据库）
export const userSecret = "vue3-admin-user-password";
```

响应封装

> 创建成功和失败两个响应类

src/utils/Response.ts

```ts
interface ResponseData {
  code: number;
  data?: any;
  message?: string;
}
class BaseResponse {
  public code!: number;
  public data: any;
  public message!: string;
  constructor({ code, data, message }: ResponseData) {
    this.code = code;
    if (data) this.data = data;
    if (message) this.message = message;
  }
}
// new SuccessResponse({token:'xxx'},'登录成功')
export class SuccessResponse extends BaseResponse {
  constructor(data: any, message?: string) {
    super({
      code: 0,
      data,
      message,
    });
  }
}
// new SuccessResponse(10004,'登录失败')
export class ErrorResponse extends BaseResponse {
  constructor(code: number, message: string) {
    super({
      code,
      message,
    });
  }
}
interface ErrorInfo {
  code: number;
  message: string;
}
// createErrorResponse({code:10004,message:'登录失败'})
export const createErrorResponse = (errorInfo: ErrorInfo) => {
  const { code, message } = errorInfo;
  return new ErrorResponse(code, message);
};
```

**hmac 摘要方法**

src/utils/createHmac.ts

```ts
import crypto from "crypto";
import { userSecret } from "../config/auth";
// md5加密
export const createHmac = (content: any) => {
  const md5 = crypto.createHmac("sha1", userSecret);
  return md5.update(content).digest("hex");
};
```

### 3.3 开发注册接口

**创建 auth 路由**

> auth 里的路由负责用户登录注册认证和用户信息获取

src/routes/auth.ts

> route 里需要调相应 controller

```ts
import Router from "@koa/router";
import { registerController } from "../controller/auth";
import { UserAttributes } from "../db/models/User.model";
const router = new Router({
  prefix: "/api/auth",
});
/**
 * 用户注册接口
 * /auth/register
 */
router.post("/register", async (ctx) => {
  ctx.body = await registerController(ctx.request.body as UserAttributes);
});
export default router;
```

**创建 controller**

src/controller/auth.ts

```ts
import { UserAttributes } from "../db/models/User.model";
import { createUser, getUserInfo } from "../services/auth";

import { ErrorResponse, SuccessResponse } from "../utils/Response";
import errorInfo from "../constants/errorInfo";
import { createHmac } from "../utils/createHmac";
const { registerUserNameExistInfo, registerFailInfo } = errorInfo;
export const registerController = async (params: UserAttributes) => {
  const { username, password } = params;
  // 注册前先看下用户是否已注册 getUserInfo services
  const userInfo = await getUserInfo({ username });
  if (userInfo) {
    // 如果已注册
    // 用户已注册
    const { code, message } = registerUserNameExistInfo;
    return new ErrorResponse(code, message);
  }
  // 用户不存在
  try {
    await createUser({
      // 创建用户
      ...params,
      password: createHmac(password),
    });
    return new SuccessResponse({});
  } catch (err) {
    // 注册失败
    const { code, message } = registerFailInfo;
    return new ErrorResponse(code, message);
  }
};
```

**创建 service**

src/services/types.ts

> services 下类型管理

```ts
export interface UserWhereProps {
  username: string;
  password?: string;
  id?: number;
}
```

src/services/auth.ts

```ts
import UserModel, { UserAttributes } from "../db/models/User.model";
import { UserWhereProps } from "./types";
import { createHmac } from "../utils/createHmac";
import { WhereOptions } from "sequelize";
/**
 * 创建用户
 */
export const createUser = async ({
  username,
  password,
  email,
  mobile,
  status,
}: UserAttributes) => {
  const result = await UserModel.create({
    username,
    password,
    email,
    mobile,
    status,
  });
  return result.toJSON();
};
/**
 * 根据用户名 获取用户信息
 * @param username 用户名
 * @param password 密码
 * @param id 用户id
 * @returns 用户信息
 */
export const getUserInfo = async ({
  username,
  password,
  id,
}: UserWhereProps): Promise<UserAttributes | null> => {
  const where: WhereOptions<UserWhereProps> = {
    username,
  };
  if (password) {
    where.password = createHmac(password);
  }
  if (typeof id != "undefined") {
    where.id = id;
  }
  const result = await UserModel.findOne({
    attributes: {
      exclude: ["password", "createdAt", "updatedAt"],
    },
    where,
  });
  if (result == null) return null;
  return result.toJSON() as UserAttributes;
};
```

## 4. 开发用户登录接口返回 token

### 4.1 安装依赖

```bash
pnpm i koa-jwt jsonwebtoken
pnpm i @types/koa-jwt @types/jsonwebtoken -D
```

koa-jwt 用户 token 认证 请求 headers 是否携带 token, 未携带直接返回未认证
[koa-jwt](https://www.npmjs.com/package/koa-jwt)

jsonwebtoken token 生成与 token 验证 [jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken) 文档

### 4.2 开发登录接口

**封装 token 生成方法**

src/utils/token.ts

```ts
import jwt from "jsonwebtoken";
import { jwtSecret } from "../config/auth";
export const createToken = (payload: any) => {
  return jwt.sign(payload, jwtSecret, { expiresIn: "6h" });
};
```

**创建登录路由**

src/routes/auth.ts

```ts
import Router from "@koa/router";
import {
  loginController,
  LoginModel,
  registerController,
} from "../controller/auth";
import { UserAttributes } from "../db/models/user";
const router = new Router({
  prefix: "/api/auth",
});
/**
 *  * 用户注册接口
 * /auth/register
 */
router.post("/register", async (ctx) => {
  ctx.body = await registerController(ctx.request.body as UserAttributes);
});
/**
 * 用户登录
 * /auth/login
 */
router.post("/login", async (ctx) => {
  ctx.body = await loginController(ctx.request.body as LoginModel);
});
export default router;
```

**创建登录 controller**

src/controller/auth.ts

```ts
const { registerUserNameExistInfo, registerFailInfo, loginFailInfo } =
  errorInfo;
export interface LoginModel {
  username: string;
  password: string;
}
export const loginController = async (params: LoginModel) => {
  const { username, password } = params;
  // 根据用户名和密码 获取用户信息
  const userInfo = await getUserInfo({ username, password });
  if (userInfo) {
    // 能获取到返回token
    const { id, username } = userInfo;
    const token = createToken({
      // 根据用户id和用户名生成token
      id,
      username,
    });
    return new SuccessResponse({ token });
  }
  // 获取不到返回 登录失败
  const { code, message } = loginFailInfo;
  return new ErrorResponse(code, message);
};
```

## 5. 添加 jwt 认证自定义 401 错误

### 5.1 修改 app.js

src/app.ts

```ts
import jwt from "koa-jwt";
import { jwtSecret } from "./config/auth";
// 自定义401错误
app.use((ctx, next) => {
  return next().catch((err) => {
    if (err.status === 401) {
      ctx.status = 401;
      ctx.body = {
        code: 401,
        error: "未登录 token失效",
      };
    } else {
      ctx.throw(err);
    }
  });
});
// token验证 header未携带token 直接返回401 Authentication Error
app.use(
  jwt({ secret: jwtSecret }).unless({
    // 白名单
    path: ["/api/auth/login", "/api/auth/register"],
  })
);
```

### 5.2 测试

> 如果接口未携带 token，并且不再白名单 会报 401 错误

添加一个测试接口

src/routes/auth.ts

```ts
router.get("/test", async (ctx) => {
  ctx.body = "测试接口";
});
```

## 6.Model 创建

### 6.1 用户 Model

src/db/models/User.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
  AllowNull,
  Default,
  BelongsToMany,
} from "sequelize-typescript";
import Role from "./Role.model";
import UserRole from "./UserRole.model";
// sequelize+typescript 参考文档
// https://sequelize.org/master/manual/typescript.html
export interface UserAttributes {
  id: number;
  username: string;
  password: string;
  email: string | null;
  mobile: string | null;
  avatar: string;
  description: string;
  isSuper: 0 | 1;
  status: 0 | 1;
}
// 用户表包含对应的角色
export type UserAttributesWithRoles = UserAttributes & { roleIds: [] };
// 用户表创建的时候，不需要的属性
interface UserCreationAttributes
  extends Optional<UserAttributes, "id" | "isSuper" | "status" | "avatar"> {}
@Table({ tableName: "user" })
class User extends Model<UserAttributes, UserCreationAttributes> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("用户id")
  @Column
  id: number;
  @AllowNull(false)
  @Comment("用户名")
  @Column
  username: string;
  @AllowNull(false)
  @Comment("密码")
  @Column
  password: string;
  @Comment("用户邮箱")
  @Column
  email: string;
  @Comment("手机号")
  @Column
  mobile: string;
  @Comment("头像")
  @Column
  avatar: string;
  @Comment("描述说明")
  @Column
  description: string;
  @Comment("超级管理员 1是 0不是")
  @Default(0)
  @Column
  isSuper: boolean;
  @Comment("账户禁用状态 1正常 0禁用")
  @Default(1)
  @Column
  status: boolean;
  // 一个用户关联多个角色
  @BelongsToMany(() => Role, () => UserRole)
  roles: Role[];
}
export default User;
```

### 6.2 角色 Model

src/db/models/Role.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
  AllowNull,
  Default,
  BelongsToMany,
} from "sequelize-typescript";
import User from "./User.model";
import UserRole from "./UserRole.model";
// 角色表中需要的属性
export interface RoleAttributes {
  id: number;
  name: string;
  description: string;
  is_default: number;
}
// 创建时所需的角色
interface RoleCreationAttributes
  extends Optional<RoleAttributes, "id" | "is_default"> {}
@Table({ tableName: "role" })
class Role extends Model<RoleAttributes, RoleCreationAttributes> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("角色 id")
  @Column
  id: number;
  @AllowNull(false)
  @Comment("角色名称 唯一")
  @Column
  name: string;
  @Comment("说明描述")
  @Column
  description: string;
  @Comment("默认角色 1是 0不是")
  @Default(1)
  @Column
  is_default: number;
  // 一个角色关联多个用户
  @BelongsToMany(() => User, () => UserRole)
  users: User[];
}
export default Role;
```

### 6.3 用户和角色关联表

src/db/models/UserRole.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
  ForeignKey,
} from "sequelize-typescript";
import Role from "./Role.model";
import User from "./User.model";
export interface UserRoleAttributes {
  id: number;
  user_id: number;
  role_id: number;
}
// 用户角色 所需的属性
interface UserRoleCreationAttributes
  extends Optional<UserRoleAttributes, "id"> {}
@Table({ tableName: "u_r" })
class UserRole extends Model<UserRoleAttributes, UserRoleCreationAttributes> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("id")
  @Column
  id: number;
  @ForeignKey(() => User)
  @Comment("外键 关联user表id")
  @Column
  user_id: number;
  @ForeignKey(() => Role)
  @Comment("外键 关联roles表id")
  @Column
  role_id: number;
}
export default UserRole;
```

### 6.4 菜单 Model

src/db/models/Access.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
  Default,
  AllowNull,
} from "sequelize-typescript";
export interface AccessAttributes {
  id: number;
  type: number;
  title: string;
  path: string;
  icon: string;
  name: string;
  sort_id: number;
  parent_id: number | null;
  status: 0 | 1;
  description: string;
}
interface UserRoleCreationAttributes extends Optional<AccessAttributes, "id"> {}
@Table({ tableName: "access" })
class Access extends Model<AccessAttributes, UserRoleCreationAttributes> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("id")
  @Column
  id: number;
  @Comment("权限类型：菜单")
  @Default(1)
  @Column
  type: number;
  @Comment("标题名称")
  @AllowNull(false)
  @Column
  title: string;
  @Comment("url地址")
  @Column
  path: string;
  @Comment("icon名称")
  @Column
  icon: string;
  @Comment("路由name")
  @Column
  name: string;
  @Comment("排序权重")
  @AllowNull(false)
  @Column
  sort_id: number;
  @Comment("父id")
  @Column
  parent_id: number;
  @Comment("状态 0禁止 1正常")
  @Default(1)
  @Column
  status: number;
  @Comment("描述")
  @Column
  description: string;
}
export default Access;
```

### 6.5 菜单和角色

src/db/models/RoleAccess.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
} from "sequelize-typescript";
export interface RoleAccessAttributes {
  id: number;
  access_id: number;
  role_id: number;
}
interface RoleAccessCreationAttributes
  extends Optional<RoleAccessAttributes, "id"> {}
@Table({ tableName: "r_a" })
class RoleAccess extends Model<
  RoleAccessAttributes,
  RoleAccessCreationAttributes
> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("id")
  @Column
  id: number;
  @Comment("外键 关联access表id")
  @Column
  access_id: number;
  @Comment("外键 关联roles表id")
  @Column
  role_id: number;
}
export default RoleAccess;
```

### 6.6. 导出 model

src/db/models/index.ts

```ts
import UserModel from "./User.model";
import RoleModel from "./Role.model";
import UserRoleModel from "./UserRole.model";
export { UserModel, RoleModel, UserRoleModel };
```

## 7.角色管理

### 7.1 角色路由表

src/routes/role.ts

```ts
import Router from "@koa/router";
import {
  addRoleController,
  getAllRoleController,
  updateRoleController,
  removeRoleController,
} from "../controller/roles";
import { RoleAttributes } from "../db/models/Role.model";
const router = new Router({
  prefix: "/api/role",
});
/**
 * 添加角色
 * post /api/role
 */
router.post("/", async (ctx) => {
  console.log(ctx.request.body);
  ctx.body = await addRoleController(ctx.request.body as RoleAttributes);
});
/**
 * 获取全部角色
 * get /api/role
 */
router.get("/", async (ctx) => {
  const { pageNum = 0, pageSize = 10 } = ctx.request.query;
  ctx.body = await getAllRoleController({
    offset: Number(pageNum),
    limit: Number(pageSize),
  });
});
/**
 * 编辑角色
 *  * put /api/role/:id
 */
router.put("/:id", async (ctx) => {
  const { id } = ctx.params;
  ctx.body = await updateRoleController(
    Number(id),
    ctx.request.body as RoleAttributes
  );
});
/**
 * 删除角色
 * delete /api/role/:id
 */
router.delete("/:id", async (ctx) => {
  const { id } = ctx.params;
  ctx.body = await removeRoleController(Number(id));
});
export default router;
```

### 7.2 角色 controller

src/controller/roles.ts

```ts
import { RoleAttributes } from "../db/models/Role.model";
import {
  createRole,
  getRole,
  getAllRoleService,
  updateRoleById,
  removeRoleById,
} from "../services/roles";
import { createErrorResponse, SuccessResponse } from "../utils/Response";
import errorInfo from "../constants/errorInfo";
const {
  addAccessFailInfo,
  addRoleNameExistInfo,
  updateRoleFailInfo,
  updateRoleNameExistInfo,
  removeRoleFailInfo,
} = errorInfo;
// 添加菜单
export const addRoleController = async (params: RoleAttributes) => {
  const result = await getRole(params.name);
  // 是否有此角色
  if (result) {
    return createErrorResponse(addRoleNameExistInfo);
  }
  if (params) {
    // 创建角色
    try {
      const result = await createRole({
        ...params,
      });
      return new SuccessResponse(result);
    } catch (error) {
      return createErrorResponse(addAccessFailInfo);
    }
  }
};
// 获取全部菜单
interface RoleListParams {
  offset: number;
  limit: number;
}
export const getAllRoleController = async ({
  offset,
  limit,
}: RoleListParams) => {
  try {
    // 获取所有角色
    const result = await getAllRoleService(offset, limit);
    return new SuccessResponse(result);
  } catch (error) {
    return createErrorResponse(addAccessFailInfo);
  }
};
// 编辑角色
export const updateRoleController = async (
  id: number,
  data: RoleAttributes
) => {
  // 查找角色是否存在
  const result = await getRole(data.name || "");
  if (result && result.id !== id) {
    return createErrorResponse(updateRoleNameExistInfo);
  }
  // 更新角色
  try {
    await updateRoleById(id, data);
    return new SuccessResponse(null, "角色编辑成功!");
  } catch (error) {
    return createErrorResponse(updateRoleFailInfo);
  }
};
// 删除角色
export const removeRoleController = async (id: number) => {
  try {
    await removeRoleById(id);
    return new SuccessResponse(null, "删除成功!");
  } catch (error) {
    return createErrorResponse(removeRoleFailInfo);
  }
};
```

### 7.3 角色 service

src/services/roles.ts

```ts
import RoleModel, { RoleAttributes } from "../db/models/Role.model";
// 创建菜单资源
export const createRole = async (params: RoleAttributes) => {
  const result = await RoleModel.create({
    ...params,
  });
  return result.toJSON();
};
// 根据角色名称获取角色
export const getRole = async (name: string) => {
  const result = await RoleModel.findOne({
    where: {
      name,
    },
  });
  if (result == null) return null;
  return result.toJSON() as RoleAttributes;
};
// 获取全部角色
export const getAllRoleService = async (offset = 0, limit = 10) => {
  const { count, rows } = await RoleModel.findAndCountAll({
    limit,
    offset: limit * offset,
  });
  return {
    roles: rows,
    count,
  };
};
// 编辑角色
export const updateRoleById = async (id: number, data: RoleAttributes) => {
  const { name, description, is_default } = data;
  const result = await RoleModel.update(
    {
      name,
      description,
      is_default,
    },
    {
      where: {
        id,
      },
    }
  );
  return result;
};
// 删除角色
export const removeRoleById = async (id: number) => {
  const result = await RoleModel.destroy({
    where: {
      id,
    },
  });
  return result;
};
```

### 7.4 注册路由

src/app.ts

```ts
import rolesRoutes from "./routes/role";
// 用户验证路由（登录 注册）
// app.use(authRoutes.routes()).use(authRoutes.allowedMethods());
// 角色管理
app.use(rolesRoutes.routes()).use(rolesRoutes.allowedMethods());
```

## 8. 获取用户信息

### 8.1 添加路由

src/routes/auth.ts

```ts
router.post("/info", async (ctx) => {
  const token = ctx.header.authorization || (ctx.request.body as any).token;
  ctx.body = await userInfoController(token);
});
```

### 8.2 添加 controller

src/controller/auth.ts

```ts
/**
 * 用户信息
 * @param param string
 */
interface UserTokenInfo {
  id: number;
  username: string;
}
export const userInfoController = async (param = "") => {
  const token = param.split(" ")[1];
  if (token) {
    // 根据token解析token信息
    const tokenInfo = await getInfoByToken<UserTokenInfo>(token);
    if (tokenInfo) {
      const { id } = tokenInfo;
      const userInfo = await getUserInfoAndRoles(id);
      return new SuccessResponse(userInfo);
    }
  }
  const { code, message } = getUserInfoFailInfo;
  return new ErrorResponse(code, message);
};
```

### 8.3 解析 Token

src/utils/token.ts

```ts
// 解析token
import util from "util";
const jwtVerify = util.promisify<string, string>(jwt.verify);
export const getInfoByToken = async <T>(token: string): Promise<T | null> => {
  try {
    const res = await jwtVerify(token, jwtSecret);
    return res as unknown as T;
  } catch (err) {
    return null;
  }
};
```

### 8.4 增添 service

src/services/auth.ts

```ts
export const getUserInfoAndRoles = async (id: number) => {
  console.log(id);
  const user = await UserModel.findOne({
    attributes: [
      "id",
      "username",
      "email",
      "mobile",
      "isSuper",
      "status",
      "avatar",
      "description",
    ],
    where: {
      id,
    },
    include: [
      // 联表查询
      {
        model: RoleModel,
        attributes: ["id", "name", "description"],
      },
    ],
  });
  return user;
};
```

## 9. 用户管理接口

### 9.1 用户路由表

src/routes/user.ts

```ts
import Router from "@koa/router";
import {
  getAllUserController,
  updateUserController,
  allocUserRoleController,
  removeUserController,
} from "../controller/user";
import { UserAttributesWithRoles } from "../db/models/User.model";
const router = new Router({
  prefix: "/api/user",
});
/**
 * 给用户分配角色
 * post /api/user/role/:id
 */
router.post("/role/:id", async (ctx) => {
  const { id } = ctx.params;
  const { roles } = ctx.request.body as { roles: number[] };
  ctx.body = await allocUserRoleController(Number(id), roles);
});
/**
 * 获取用户列表
 * get /api/user
 */
router.get("/", async (ctx) => {
  const { pageNum = 0, pageSize = 10, ...query } = ctx.request.query;
  ctx.body = await getAllUserController({
    offset: Number(pageNum),
    limit: Number(pageSize),
    query,
  });
});
/**
 * 编辑用户roles
 * * post /api/user/:id
 */
router.put("/:id", async (ctx) => {
  const { id } = ctx.params;
  ctx.body = await updateUserController(
    Number(id),
    ctx.request.body as UserAttributesWithRoles
  );
});
/**
 * 删除用户
 * delete /api/user/:id
 */
router.delete("/:id", async (ctx) => {
  const { id } = ctx.params;
  ctx.body = await removeUserController(Number(id));
});
export default router;
```

### 9.2 用户 controller

src/controller/user.ts

```ts
import {
  getAllUserService,
  updateUserService,
  allocUserRoleService,
  destroyUserRoleByUserID,
  removeUserService,
} from "../services/user";
import { createErrorResponse, SuccessResponse } from "../utils/Response";
import errorInfo from "../constants/errorInfo";
import {
  UserAttributes,
  UserAttributesWithRoles,
} from "../db/models/User.model";
import { getUserInfo } from "../services/auth";
const {
  updateUserExistFailInfo,
  getUserListFailInfo,
  allocUserRoleFailInfo,
  deleteUserInfoFailInfo,
} = errorInfo;

// 分配用户角色
export const allocUserRoleController = async (
  id: number,
  roles: number[] = []
) => {
  // 移除之前该用户与角色记录
  await destroyUserRoleByUserID(id);
  try {
    await allocUserRoleService(id, roles);
    return new SuccessResponse(null, "用户角色分配成功");
  } catch (error) {
    console.log(error);
    return createErrorResponse(allocUserRoleFailInfo);
  }
};
// 获取全部菜单
export interface WhereQuery {
  name: string;
  status: number;
  mobile: string;
}
export interface UserListParams {
  offset: number;
  limit: number;
  query: Record<string, any>;
}
// 获取全部用户列表
export const getAllUserController = async ({
  offset,
  limit,
  query,
}: UserListParams) => {
  try {
    // 获取所有用户
    const result = await getAllUserService(offset, limit, query);
    return new SuccessResponse(result);
  } catch (error) {
    console.log(error);
    return createErrorResponse(getUserListFailInfo);
  }
};
// 更改用户信息
export const updateUserController = async (
  id: number,
  data: UserAttributesWithRoles
) => {
  const { username, email, mobile, description, status, roleIds } = data;
  // 判断修改后的用户名是否已经存在其他重名用户
  const userInfo = await getUserInfo({ username });
  if (userInfo && userInfo.id !== id) {
    return createErrorResponse(updateUserExistFailInfo);
  }
  try {
    await updateUserService(id, {
      username,
      email,
      mobile,
      description,
      status,
    } as UserAttributes);
    await destroyUserRoleByUserID(id); // 销毁角色重新分配
    await allocUserRoleController(id, roleIds);
    return new SuccessResponse(null, "用户信息修改成功");
  } catch (error) {
    return createErrorResponse(getUserListFailInfo);
  }
};
// 删除用户
export const removeUserController = async (id: number) => {
  try {
    await removeUserService(id);
    return new SuccessResponse(null, "用户删除成功");
  } catch (error) {
    return createErrorResponse(deleteUserInfoFailInfo);
  }
};
```

### 9.3 用户 services

src/services/user.ts

```ts
import { RoleModel, UserModel, UserRoleModel } from "../db/models";
import { UserAttributes } from "../db/models/User.model";
// 分配用户角色
export const allocUserRoleService = async (id: number, data: number[]) => {
  const roles = data.map((rid) => ({
    user_id: id,
    role_id: rid,
  }));
  const result = await UserRoleModel.bulkCreate(roles);
  return result;
};
// 获取全部用户
export const getAllUserService = async (
  offset = 0,
  limit = 10,
  query: Record<string, any>
) => {
  const whereProps = {} as Record<string, any>;
  // 检索条件处理
  if (query.mobile) {
    whereProps.mobile = query.mobile;
  }
  if (query.username) {
    whereProps.username = query.username;
  }
  if (!isNaN(query.status)) {
    whereProps.status = Number(query.status);
  }
  const { count, rows } = await UserModel.findAndCountAll({
    attributes: [
      "id",
      "username",
      "email",
      "mobile",
      "isSuper",
      "status",
      "avatar",
      "description",
      "createdAt",
    ],
    where: whereProps,
    limit,
    offset: limit * offset,
    distinct: true,
    include: [
      // 联表查询
      {
        model: RoleModel,
        attributes: ["id", "name", "description"],
      },
    ],
  });
  // 数据格式化
  return {
    users: rows,
    count,
  };
};
// 修改用户
export const updateUserService = async (id: number, data: UserAttributes) => {
  const result = await UserModel.update(data, {
    where: {
      id,
    },
  });
  return result;
};
/**
 * 删除与该用户相关联记录
 * @param id 角色id
 */
export const destroyUserRoleByUserID = async (id: number) => {
  const result = await UserRoleModel.destroy({
    where: {
      user_id: id,
    },
  });
  return result;
};
// 根据用户id删除用户
export const removeUserService = async (id: number) => {
  const result = await UserModel.destroy({
    where: {
      id,
    },
  });
  return result;
};
```

### 9.4 注册路由

src/app.ts

```ts
import userRoutes from "./routes/user";
app.use(userRoutes.routes()).use(userRoutes.allowedMethods());
```

### 9.5 注册逻辑补充

src/controller/auth.ts

```ts
export const registerController = async (params:
UserAttributesWithRoles) => {
+ const { username, password = "111111" } = params; // 默认密码
 // 注册前先看下用户是否已注册 getUserInfo services
 const userInfo = await getUserInfo({ username });
 if (userInfo) {
 // 如果已注册
 const { code, message } = registerUserNameExistInfo;
 return new ErrorResponse(code, message);
 }
 // 用户不存在
 try {
+ const { roleIds = [] } = params;
+ const result = await createUser({
+ // 创建用户
+ ...params,
+ password: createHmac(password),
+ });
+ await allocUserRoleService(result.id, roleIds);
 return new SuccessResponse({});
 } catch (err) {
 // 注册失败
 const { code, message } = registerFailInfo;
 return new ErrorResponse(code, message);
 }
};
```

## 10.菜单管理

### 10.1 菜单 model

src/db/models/Access.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
  Default,
  AllowNull,
} from "sequelize-typescript";
export interface AccessAttributes {
  id: number;
  type: number;
  title: string;
  path: string;
  icon: string;
  name: string;
  sort_id: number;
  parent_id: number | null;
  status: 0 | 1;
  description: string;
}
interface UserRoleCreationAttributes extends Optional<AccessAttributes, "id"> {}
@Table({ tableName: "access" })
class Access extends Model<AccessAttributes, UserRoleCreationAttributes> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("id")
  @Column
  id: number;
  @Comment("权限类型：菜单")
  @Default(1)
  @Column
  type: number;
  @Comment("标题名称")
  @AllowNull(false)
  @Column
  title: string;
  @Comment("url地址")
  @Column
  path: string;
  @Comment("icon名称")
  @Column
  icon: string;
  @Comment("路由name")
  @Column
  name: string;
  @Comment("排序权重")
  @AllowNull(false)
  @Column
  sort_id: number;
  @Comment("父id")
  @Column
  parent_id: number;
  @Comment("状态 0禁止 1正常")
  @Default(1)
  @Column
  status: number;
  @Comment("描述")
  @Column
  description: string;
}
export default Access;
```

### 10.2 菜单 controller

src/controller/access.ts

```ts
import {
  createAccess,
  getAllAccess,
  removeAccessById,
  updateAccessById,
  updateBulkAccess,
} from "../services/access";
import { createErrorResponse, SuccessResponse } from "../utils/Response";
import errorInfo from "../constants/errorInfo";
import { AccessAttributes } from "../db/models/Access.model";
const {
  addAccessFailInfo,
  getAccessAllFailInfo,
  removeAccessFailInfo,
  updateAccessFailInfo,
} = errorInfo;
export const addAccessController = async (params: AccessAttributes) => {
  if (params) {
    try {
      const result = await createAccess({
        ...params,
      });
      return new SuccessResponse(result);
    } catch (error) {
      return createErrorResponse(addAccessFailInfo);
    }
  }
};
export const getAccessAllController = async () => {
  try {
    const result = await getAllAccess();
    return new SuccessResponse(result);
  } catch (error) {
    return createErrorResponse(getAccessAllFailInfo);
  }
};
export const removeAccessController = async (id: number) => {
  try {
    await removeAccessById(id);
    return new SuccessResponse(null, "删除成功!");
  } catch (error) {
    return createErrorResponse(removeAccessFailInfo);
  }
};
export const updateAccessController = async (
  id: number,
  data: AccessAttributes
) => {
  try {
    await updateAccessById(id, data);
    return new SuccessResponse(null, "菜单更新成功!");
  } catch (error) {
    return createErrorResponse(updateAccessFailInfo);
  }
};
export const updateBulkAccessController = async (data: AccessAttributes[]) => {
  try {
    await updateBulkAccess(data);
    return new SuccessResponse(null, "菜单更新成功!");
  } catch (error) {
    return createErrorResponse(updateAccessFailInfo);
  }
};
```

### 10.3 菜单 services

src/services/access.ts

```ts
import Sequelize from "sequelize";
import AccessModel, { AccessAttributes } from "../db/models/Access.model";
// Sequelize 操作对象 里面包含了 多条件操作 and or in get等
// 操作符参考文档
// https://www.sequelize.com.cn/core-concepts/model-queryingbasics#%E5%BA%94%E7%94%A8-where-%E5%AD%90%E5%8F%A5
// https://www.sequelize.com.cn/core-concepts/model-queryingbasics#%E6%93%8D%E4%BD%9C%E7%AC%A6
const OP = Sequelize.Op;
// 创建菜单资源
export const createAccess = async (params: AccessAttributes) => {
  const result = await AccessModel.create({
    ...params,
  });
  return result.toJSON();
};
// 获取所有菜单资源
export const getAllAccess = async () => {
  const result = await AccessModel.findAll({
    order: [["sort_id", "ASC"]],
  });
  return result;
};
// 通过id删除菜单 包括parentId为该id的菜单
export const removeAccessById = async (id: number) => {
  const result = await AccessModel.destroy({
    where: {
      [OP.or]: [
        // id=1 or parent_id=1
        { id },
        { parent_id: id },
      ],
    },
  });
  return result;
};
// 编辑菜单
export const updateAccessById = async (id: number, data: AccessAttributes) => {
  const { title, name, path, icon } = data;
  const result = await AccessModel.update(
    {
      title,
      name,
      path,
      icon,
    },
    {
      where: {
        id,
      },
    }
  );
  return result;
};
// 批量更新菜单
export const updateBulkAccess = async (data: AccessAttributes[]) => {
  console.log("data", data);
  const result = await AccessModel.bulkCreate(data, {
    updateOnDuplicate: ["sort_id"],
  });
  return result;
};
```

src/db/models/index.ts

```ts
import UserModel from "./User.model";
import RoleModel from "./Role.model";
import UserRoleModel from "./UserRole.model";
import AccessModel from "./Access.model";
export { UserModel, RoleModel, UserRoleModel, AccessModel };
```

### 10.4 注册路由

```ts
import accessRoutes from "./routes/access";
app.use(accessRoutes.routes()).use(accessRoutes.allowedMethods());
```

src/routes/access.ts

```ts
import Router from "@koa/router";
import {
  addAccessController,
  getAccessAllController,
  removeAccessController,
  updateAccessController,
  updateBulkAccessController,
} from "../controller/access";
import { AccessAttributes } from "../db/models/Access.model";
const router = new Router({
  prefix: "/api/access",
});
/**
 * 添加菜单
 * post /api/access/menu
 */
router.post("/menu", async (ctx) => {
  ctx.body = await addAccessController(ctx.request.body as AccessAttributes);
});
/**
 * 获取菜单
 * get /api/access/menu
 */
router.get("/menu", async (ctx) => {
  ctx.body = await getAccessAllController();
});
/**
 * * 删除某一个菜单
 * delete /api/access/menu
 */
router.delete("/menu/:id", async (ctx) => {
  const { id } = ctx.params;
  ctx.body = await removeAccessController(Number(id));
});
/**
 * 编辑某一个菜单
 * put /api/access/menu/:id
 */
router.put("/menu/:id", async (ctx) => {
  const { id } = ctx.params;
  ctx.body = await updateAccessController(
    Number(id),
    ctx.request.body as AccessAttributes
  );
});
/**
 * 批量更新菜单用于菜单排序操作
 * patch /api/access/menu/update
 */
router.patch("/menu/update", async (ctx) => {
  const { access } = ctx.request.body as { access: AccessAttributes[] };
  ctx.body = await updateBulkAccessController(access);
});
export default router;
```

## 11. 角色与菜单权限路由

### 11.1 角色权限 Model

src/db/models/RoleAccess.model.ts

```ts
import { Optional } from "sequelize";
import {
  Table,
  Model,
  Column,
  AutoIncrement,
  PrimaryKey,
  Comment,
  ForeignKey,
} from "sequelize-typescript";
import Access from "./Access.model";
import Role from "./Role.model";
export interface RoleAccessAttributes {
  id: number;
  access_id: number;
  role_id: number;
}
interface RoleAccessCreationAttributes
  extends Optional<RoleAccessAttributes, "id"> {}
@Table({ tableName: "r_a" })
class RoleAccess extends Model<
  RoleAccessAttributes,
  RoleAccessCreationAttributes
> {
  @PrimaryKey //主键
  @AutoIncrement //自增
  @Comment("id")
  @Column
  id: number;
  @ForeignKey(() => Access)
  @Comment("外键 关联access表id")
  @Column
  access_id: number;
  @ForeignKey(() => Role)
  @Comment("外键 关联roles表id")
  @Column
  role_id: number;
}
export default RoleAccess;
```

### 10.2 角色 Model

src/db/models/Role.model.ts

```ts
@Table({ tableName: "role" })
class Role extends Model<RoleAttributes, RoleCreationAttributes> {
  // 一个角色关联多个权限
  @BelongsToMany(() => Access, () => RoleAccess)
  access: Access[];
}
export default Role;
```

### 10.3 菜单 Model

src/db/models/Access.model.ts

```ts
@Table({ tableName: "access" })
class Access extends Model<AccessAttributes, UserRoleCreationAttributes> {
  // 一个菜单关联多个角色
  @BelongsToMany(() => Role, () => RoleAccess)
  roles: Role[];
}
export default Access;
```

### 10.4 路由表

src/app.ts

```ts
import roleAccessRoutes from "./routes/roleAccess";
app.use(roleAccessRoutes.routes()).use(roleAccessRoutes.allowedMethods());
```

src/routes/roleAccess.ts

```ts
import Router from "@koa/router";
import {
  addRoleAccessController,
  getRoleAccessController,
  getAccessByRolesController,
} from "../controller/roleAccess";
const router = new Router({
  prefix: "/api/role_access",
});
/**
 * 添加菜单与角色关联
 * post /api/role_access' . 某个角色关联某个菜单
 */
router.post("/:id", async (ctx) => {
  const { id } = ctx.params;
  const { access } = ctx.request.body as { access: number[] };
  ctx.body = await addRoleAccessController(Number(id), access);
});
/**
 * 根据角色id获取关联菜单id
 * post /api/role_access'
 */
router.get("/:id", async (ctx) => {
  const { id } = ctx.params;
  ctx.body = await getRoleAccessController(Number(id));
});
/**
 * 通过角色获取权限
 * post /role/access'
 */
router.post("/role/access", async (ctx) => {
  const { roles } = ctx.request.body as { roles: string[] };
  const ids = roles.map(Number);
  ctx.body = await getAccessByRolesController(ids);
  // ctx.body = typeof roles
});
export default router;
```

### 10.5 角色权限 controller

src/controller/roleAccess.ts

```ts
import {
  createRoleAccess,
  destroyRoleAccessByRoleID,
  getRoleAccessByID,
  getAccessByRolesService,
} from "../services/roleAccess";
import { SuccessResponse, createErrorResponse } from "../utils/Response";
import errorInfo from "../constants/errorInfo";
const { allocRoleAccessFailInfo, getRoleAccessFailInfo } = errorInfo;
export const addRoleAccessController = async (id: number, access: number[]) => {
  // 先移除之前该角色关联记录
  await destroyRoleAccessByRoleID(id);
  try {
    // 批量插入记录
    await createRoleAccess(id, access);
    return new SuccessResponse(null, "权限分配成功");
  } catch (error) {
    console.error(error);
    return createErrorResponse(allocRoleAccessFailInfo);
  }
};
export const getRoleAccessController = async (id: number) => {
  try {
    // 批量插入记录
    const result = await getRoleAccessByID(id);
    return new SuccessResponse(result);
  } catch (error) {
    return createErrorResponse(getRoleAccessFailInfo);
  }
};
export const getAccessByRolesController = async (roles: number[]) => {
  try {
    // 批量插入记录
    const result = await getAccessByRolesService(roles);
    return new SuccessResponse(result);
  } catch (error) {
    console.log(error);
    return createErrorResponse(getRoleAccessFailInfo);
  }
};
```

### 10.6 角色权限 services

src/services/roleAccess.ts

```ts
import { AccessModel, RoleAccessModel, RoleModel } from "../db/models";
import Sequelize from "sequelize";

const Op = Sequelize.Op;
/**
 * 删除与该角色相关联记录
 * @param id 角色id
 */
export const destroyRoleAccessByRoleID = async (id: number) => {
  const result = await RoleAccessModel.destroy({
    where: {
      role_id: id,
    },
  });
  return result;
};
/**
 * 添加与该角色相关联记录
 * @param id 角色id
 * @param access 菜单id列表
 */
export const createRoleAccess = async (id: number, access: number[]) => {
  const records = access.map((aid) => ({
    role_id: id,
    access_id: aid,
  }));
  // 批量插入
  const result = await RoleAccessModel.bulkCreate(records);
  return result;
};
/**
 * 获取与该角色相关联记录
 * @param id 角色id
 */
export const getRoleAccessByID = async (id: number) => {
  const result = await RoleAccessModel.findAll({
    attributes: ["id", "role_id", "access_id"],
    where: {
      role_id: id,
    },
  });
  return result;
};
export const getAccessByRolesService = async (roles: number[]) => {
  const { rows: access } = await AccessModel.findAndCountAll({
    distinct: true,
    order: [["sort_id", "ASC"]],
    include: [
      {
        model: RoleModel,
        attributes: ["id", "name", "description"],
        where: {
          id: {
            [Op.in]: roles,
          },
        },
      },
    ],
  });
  return {
    access,
  };
};
```
